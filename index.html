<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PC BOARD</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Special+Elite&family=Permanent+Marker&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #1a1a1a;
            --dot-color: #2a2a2a;
            --main-font: 'Special Elite', system-ui;
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: var(--bg-color);
            background-image: radial-gradient(var(--dot-color) 15%, transparent 16%);
            background-size: 25px 25px;
            font-family: var(--main-font);
            color: white;
            user-select: none;
        }

        #toolbar {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #222;
            padding: 10px 20px;
            border-radius: 8px;
            display: flex;
            gap: 15px;
            align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            z-index: 1000;
            border: 1px solid #444;
        }

        .tool-btn {
            background: #444;
            border: 1px solid #666;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            font-size: 13px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #board {
            width: 100vw;
            height: 100vh;
            position: relative;
            overflow: hidden;
            cursor: grab;
        }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            transform-origin: 0 0;
        }

        #connections {
            position: absolute;
            top: 0;
            left: 0;
            overflow: visible;
            pointer-events: none;
            z-index: 1;
        }

        .item {
            position: absolute;
            min-width: 50px;
            min-height: 50px;
            box-shadow: 5px 5px 15px rgba(0,0,0,0.5);
            z-index: 2;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
        }

            .item.selected {
                outline: 4px solid #00ffcc;
                z-index: 5;
            }

        .item-content {
            width: 100%;
            height: 100%;
            outline: none;
            white-space: pre-wrap;
            padding: 15px;
            box-sizing: border-box;
            color: #000;
            font-weight: bold;
            overflow-y: auto;
            font-family: inherit;
            cursor: text;
            user-select: text;
        }

        /* IMAGE STRETCH FIX: Changed object-fit to 'fill' to allow free distortion */
        .item img {
            width: 100%;
            height: 100%;
            object-fit: fill;
            pointer-events: none;
            display: block;
        }

        /* AUDIO FIXES: Bigger text and internal padding for alignment */
        .audio-container {
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
            height: 100%;
            justify-content: center;
            box-sizing: border-box;
        }

        .audio-name {
            color: #000;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-bottom: 5px;
        }

        audio {
            width: 100%;
            height: 35px;
            filter: invert(100%) hue-rotate(180deg) brightness(1.5);
        }

        .resizer {
            width: 22px;
            height: 22px;
            background: rgba(0,0,0,0.4);
            position: absolute;
            right: 0;
            bottom: 0;
            cursor: nwse-resize;
            z-index: 10;
            border-radius: 0 0 4px 0;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .del-btn {
            position: absolute;
            top: -12px;
            right: -12px;
            width: 26px;
            height: 26px;
            background: #ff4444;
            color: white;
            border-radius: 50%;
            text-align: center;
            cursor: pointer;
            font-weight: bold;
            line-height: 26px;
            z-index: 11;
            border: 2px solid white;
            display: none;
        }

        .item:hover .del-btn {
            display: block;
        }
    </style>
</head>
<body>

    <div id="start-screen" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#111; z-index:2000; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:20px;">
        <h1 style="border: 4px solid red; padding: 20px;">PC BOARD</h1>
        <div style="display:flex; gap: 20px;">
            <button class="tool-btn" onclick="initBoard('new')">NEW BOARD</button>
            <button class="tool-btn" onclick="document.getElementById('file-loader').click()">LOAD .BOARD</button>
        </div>
        <input type="file" id="file-loader" style="display:none" accept=".board" onchange="loadBoardFile(this)">
    </div>

    <div id="board" onmousedown="startPan(event)" onwheel="handleZoom(event)">
        <div id="canvas">
            <svg id="connections"></svg>
        </div>
    </div>

    <div id="toolbar">
        <input type="color" id="item-color-picker" value="#ffeb3b" style="width:40px; height:35px;" oninput="liveUpdateColor(this.value)">
        <button class="tool-btn" onclick="addItem('note')">üìù Note</button>
        <button class="tool-btn" onclick="triggerUpload('image')">üì∑ Image</button>
        <button class="tool-btn" onclick="triggerUpload('sound')">üéôÔ∏è Audio</button>
        <button id="btn-connect" class="tool-btn" onclick="toggleConnectMode()">üîó String</button>
        <button class="tool-btn" onclick="undo()">‚Ü© Undo</button>
        <button class="tool-btn" onclick="saveBoard()" style="background:#28a745;">üíæ Save</button>
    </div>

    <input type="file" id="universal-upload" style="display:none">

    <script>
        let state = { items: [], connections: [], view: { x: 0, y: 0, zoom: 1 } };
        let history = []; let historyIndex = -1;
        let connectMode = false, connectStartId = null, selectedId = null, offset = { x: 0, y: 0 };

        function initBoard(m) { if (m === 'new') saveHistory(); document.getElementById('start-screen').style.display = 'none'; render(); }
        function saveHistory() { if (historyIndex < history.length - 1) history = history.slice(0, historyIndex + 1); history.push(JSON.parse(JSON.stringify(state))); historyIndex++; }
        function undo() { if (historyIndex > 0) { historyIndex--; state = JSON.parse(JSON.stringify(history[historyIndex])); updateCanvasTransform(); render(); } }

        function liveUpdateColor(val) {
            if (selectedId) {
                const item = state.items.find(i => i.id === selectedId);
                if (item && item.type !== 'image') {
                    item.color = val;
                    const el = document.getElementById(selectedId);
                    if (el) el.style.background = val;
                }
            }
        }

        function addItem(type, content = '', name = 'Evidence') {
            const cx = (window.innerWidth / 2 - state.view.x) / state.view.zoom;
            const cy = (window.innerHeight / 2 - state.view.y) / state.view.zoom;
            const id = 'itm' + Date.now();
            // Default size for audio is slightly larger to fit the bigger text
            state.items.push({ id, type, x: cx - 100, y: cy - 100, w: type === 'sound' ? 320 : 200, h: type === 'sound' ? 140 : 200, content, color: document.getElementById('item-color-picker').value, fileName: name });
            selectedId = id;
            saveHistory(); render();
        }

        function render() {
            const canvas = document.getElementById('canvas');
            canvas.querySelectorAll('.item').forEach(el => el.remove());
            state.items.forEach(item => {
                const el = document.createElement('div');
                el.id = item.id; el.className = 'item' + (selectedId === item.id ? ' selected' : '');
                el.style.cssText = `left:${item.x}px; top:${item.y}px; width:${item.w}px; height:${item.h}px; background:${item.type === 'image' ? 'transparent' : item.color}; font-family:var(--main-font); cursor:grab;`;

                if (item.type === 'note') {
                    el.innerHTML = `<div class="item-content" contenteditable="true" spellcheck="false">${item.content || 'Click to type...'}</div>`;
                    const box = el.querySelector('.item-content');
                    box.oninput = () => { item.content = box.innerText; };
                    box.onmousedown = (e) => { e.stopPropagation(); selectItem(item.id); };
                } else if (item.type === 'image') {
                    el.innerHTML = `<img src="${item.content}">`;
                } else if (item.type === 'sound') {
                    el.innerHTML = `
                            <div class="audio-container">
                                <div class="audio-name">${item.fileName}</div>
                                <audio controls src="${item.content}"></audio>
                            </div>`;
                    el.querySelector('audio').onmousedown = (e) => e.stopPropagation();
                }

                el.innerHTML += `<div class="resizer"></div><div class="del-btn">X</div>`;

                el.onmousedown = (e) => {
                    if (e.target.classList.contains('del-btn')) {
                        state.items = state.items.filter(i => i.id !== item.id);
                        state.connections = state.connections.filter(c => c.from !== item.id && c.to !== item.id);
                        saveHistory(); render(); return;
                    }
                    if (e.target.classList.contains('resizer')) { startResize(e, item.id); return; }
                    if (connectMode) { handleConnectClick(item.id); return; }
                    selectItem(item.id);
                    startDrag(e, item.id);
                };
                canvas.appendChild(el);
            });
            drawLines();
        }

        function selectItem(id) {
            selectedId = id;
            const item = state.items.find(i => i.id === id);
            if (item && item.color) document.getElementById('item-color-picker').value = item.color;
            document.querySelectorAll('.item').forEach(el => el.classList.toggle('selected', el.id === id));
        }

        function startDrag(e, id) {
            const item = state.items.find(i => i.id === id);
            offset.x = e.clientX / state.view.zoom - item.x;
            offset.y = e.clientY / state.view.zoom - item.y;
            document.onmousemove = (ev) => {
                item.x = ev.clientX / state.view.zoom - offset.x; item.y = ev.clientY / state.view.zoom - offset.y;
                const el = document.getElementById(id); el.style.left = item.x + 'px'; el.style.top = item.y + 'px';
                drawLines();
            };
            document.onmouseup = () => { document.onmousemove = null; saveHistory(); };
        }

        function startResize(e, id) {
            e.stopPropagation(); const item = state.items.find(i => i.id === id);
            offset.w = e.clientX / state.view.zoom - item.w; offset.h = e.clientY / state.view.zoom - item.h;
            document.onmousemove = (ev) => {
                item.w = Math.max(50, ev.clientX / state.view.zoom - offset.w); item.h = Math.max(50, ev.clientY / state.view.zoom - offset.h);
                const el = document.getElementById(id); el.style.width = item.w + 'px'; el.style.height = item.h + 'px';
                drawLines();
            };
            document.onmouseup = () => { document.onmousemove = null; saveHistory(); };
        }

        function drawLines() {
            const svg = document.getElementById('connections'); svg.innerHTML = '';
            state.connections.forEach(conn => {
                const i1 = state.items.find(i => i.id === conn.from), i2 = state.items.find(i => i.id === conn.to);
                if (i1 && i2) {
                    const l = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    l.setAttribute('x1', i1.x + i1.w / 2); l.setAttribute('y1', i1.y + i1.h / 2);
                    l.setAttribute('x2', i2.x + i2.w / 2); l.setAttribute('y2', i2.y + i2.h / 2);
                    l.setAttribute('stroke', conn.color); l.setAttribute('stroke-width', '4');
                    svg.appendChild(l);
                }
            });
        }

        async function saveBoard() {
            const data = JSON.stringify(state);
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([data])); a.download = "PC_Board.board"; a.click();
        }

        function loadBoardFile(i) {
            const r = new FileReader();
            r.onload = (e) => { state = JSON.parse(e.target.result); updateCanvasTransform(); render(); };
            r.readAsText(i.files[0]); document.getElementById('start-screen').style.display = 'none';
        }

        function triggerUpload(t) {
            const inp = document.getElementById('universal-upload');
            inp.accept = t === 'image' ? 'image/*' : 'audio/*';
            inp.onchange = (e) => {
                const f = e.target.files[0];
                const r = new FileReader();
                r.onload = (ev) => addItem(t, ev.target.result, f.name);
                r.readAsDataURL(f);
            };
            inp.click();
        }

        function toggleConnectMode() { connectMode = !connectMode; connectStartId = null; document.getElementById('btn-connect').style.background = connectMode ? 'red' : '#444'; }
        function handleConnectClick(id) { if (!connectStartId) connectStartId = id; else { if (connectStartId !== id) { state.connections.push({ from: connectStartId, to: id, color: document.getElementById('item-color-picker').value }); saveHistory(); } connectStartId = null; connectMode = false; document.getElementById('btn-connect').style.background = '#444'; render(); } }
        function startPan(e) { if (e.target.id !== 'board') return; offset.x = e.clientX - state.view.x; offset.y = e.clientY - state.view.y; document.onmousemove = (ev) => { state.view.x = ev.clientX - offset.x; state.view.y = ev.clientY - offset.y; updateCanvasTransform(); }; document.onmouseup = () => { document.onmousemove = null; }; }
        function handleZoom(e) { e.preventDefault(); const oz = state.view.zoom; const nz = Math.min(Math.max(0.1, oz + (-e.deltaY * 0.001)), 3); state.view.x = e.clientX - (e.clientX - state.view.x) * (nz / oz); state.view.y = e.clientY - (e.clientY - state.view.y) * (nz / oz); state.view.zoom = nz; updateCanvasTransform(); }
        function updateCanvasTransform() { document.getElementById('canvas').style.transform = `translate(${state.view.x}px, ${state.view.y}px) scale(${state.view.zoom})`; }
    </script>
</body>
</html>
